# Open 채팅방 질의 응답 복기

# 멀티스레드

> 스레드 여러개 돌려봤자 동시에 돌릴 수 있는 스레드는 코어 개수만큼밖에 없어요

> 클라우드 질문은 아닌데 멀티 스레드하고 관련하여서 궁금한 점이 생겼습니다!
스프링에서 톰캣이 대략 200개 정도 스레드를 가지고 클라이언트 요청에 대해 응답을 한다고 알고 있는데 
멀티스레드로 하면 코어수가 정해져있으니 컨텍스트 스위칭 비용이 스레드수만큼 발생할텐데 코어수만큼 스레드를 가져가지않고 
이렇게 멀티스레드로 하면 어떤부분이 좋을까요 ??
> 저는 대략적으로 IO, 비동기 키워드 정도로만 알고 있습니다 ..

> 스레드 너무 많아도 손해에요
지금 스펙에서 적당한 개수는 찾아보셔야 하구요
스레드 내부에서 공유하는 메모리가 있다는 점을 장점으로 가져갈 수 있겠죠

> 스레드가 io 작업으로 blocking 되면 어차피 context switch는 발생하니 그 시간동안 다른 스레드를 돌릴 수 있는게 장점 아닐까요?

> cpu intensive 하지 않은 작업일 경우 다른데에서 block 이 걸려서 cpu 가 쉴테니 여러 쓰레드 만들어서 더 빡씨게 굴리는거죠 뭐 껄껄

> 음.. 예를 들어서 QPS(Query Per Second)가 200, 요청당 소요 시간이 1초라 가정해보죠.
쓰레드가 예를 들어 CPU 당 하나만 있다고 가정했을 때 4코어면 4개있는거죠.
1초 걸리는 요청이 1초에 200건 들어온다고 하면 4개의 쓰레드를 모두 사용하면 나머지 196건에 대해선 대기해야만 하겠죠.
거기다가 1초에 200건이면 1분에 12000건이니까, 대략적으로 계산하더라도, 컨텍스트 스위칭 비용보다 앞단에서 큐에 저장하는 메모리가 더 큰 상황이에요.
그래서 쓰레드를 사용하는겁니다. 메모리와 CPU를 고려해서요.
톰캣은 멀티쓰레드 기반이고, 제티는 싱글쓰레드 기반이에요.
톰캣은 Spring Web MVC에서 사용하고, 제티는 Spring Webflux에서 사용해요.
두 가지 다 장단점이 있고, 사용하는 처가 달라요~

> 오 감사합니다! 정리가 되었습니다

>스프링 mvc에서 스프링은 1요청 1 스레드이다
그래서 스프릥 security 에서는 스레드 로컬을 사용한다
스레드로컬 = 각각의 스레드에서 각각의 로컬변수를 담기위해 사용


> 여기서 소요시간이라는게 CPU 를 사용하는 시간이 아닌거죠 ?
이 소요시간에서 CPU를 사용하는 시간이 매우 적으니, 이 CPU를 사용하는 시간을 극대화하기 위해서 스레드를 돌려가면서 CPU를 쓰게되니, 전체적인 응답시간이 12000초 -> ???초 가 될 수 있는거겠죠 ?

> 넵넵 소요시간은 Request -> Response 받기까지의 시간이라고 보시면 될 것 같아요.
전체적인 응답 시간은 계속 뒤로 밀려요. 1초에 200건인데, 1초에 4건밖에 처리를 못하니까요.

> 국룰질문: 쓰레드는 많으면 많을수록 무조건 성능이 좋아질까유?
(리소스, 컨텍스트 스위칭, db connection, ...)

> 스레드가 너무 많아버리면 사용하지 않는 스레드가 자원을 차지해서일까요 ?

> 일단 그렇고, 쓰레드를 사용할 때마다 생성하냐, 쓰레드 풀에 생성해놓냐의 차이도 있어요

> 쓰레드풀을 보통 사용하지 않을까요 ?

> 스레드가 좋지 않다면 자바가 가상스레드를 지원할리가 없다

> 아 가상스레드 ? 는 처음들어보네요 .. 찾아봐야겠다

> 오 .. 기술이 이렇게 발전을 하는군여 .. 운영체제의 가상메모리 주소 공간의 동작방식 개념을 스레드에서도 사용한다 ..

> 버추얼 스레드는 추상화라기보다는 스레드를 잘게 쪼개서, 코드를 통해 스레드의 개념을 구현한 거에요
그래서 버추얼이라는 단어가 쓰인거에요

> 버추얼 스레드는 개념상으로는 스레드이긴 하지만, 자바에서 현재 지향하는 방식인 Combined 스레드는 아닌거죠
가상 스레드는 기존의 스레드를 완전히 대체할 수 있도록 개발되었어요
컨텍스트 스위칭 비용도 매우 저렴하고, 생명주기 시작과 끝의 비용도 저렴하죠

> 가상스레드 써봤는데 기존 스레드 방식이 더 좋지 않을까 싶어요

> 요거 써봤는데 좋더라구요
Blocking IO 가 많을때 쓰면 성능이 많이 올라갑니다

> 맞아요 스레드도 저 위의 대화에서 블로킹이 어쩌구.. 하면서 성능이 향상되는 걸로 결론 낫듯이 가상 스레드도 향상돼요


